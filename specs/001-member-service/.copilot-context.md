Update# Member Service Development Context

> **Feature-Specific Context for GitHub Copilot**  
> This file provides AI coding assistance context for the 001-member-service feature.
> It will be merged into the global `.github/copilot-instructions.md` when this feature is merged to master.

## Feature: Member Service (001-member-service)

**Status**: In Development (Branch: `001-member-service`)  
**Last Updated**: 2025-12-02

### Technology Stack

- **Language/Framework**: ASP.NET Core 10, C# 13 (.NET 10 LTS)
- **Architecture**: Clean Architecture (4 layers: Domain/Application/Infrastructure/API)
- **Database**: 
  - **本地開發**: PostgreSQL 16 (Docker 容器或本機安裝)
  - **正式環境**: Azure Database for PostgreSQL / AWS RDS PostgreSQL (雲端託管)
  - **建置方式**: EF Core 10 Code-First Migrations (資料庫結構由程式碼自動產生)
- **Primary Dependencies**:
  - `IdGen` 3.x - Snowflake ID 產生器（64-bit 分散式唯一識別碼）
  - `BCrypt.Net-Next` 4.0.3 - 密碼雜湊（bcrypt + snowflakeId，work factor 12）
  - `System.IdentityModel.Tokens.Jwt` 8.0.0 - JWT 驗證（HS256 對稱式加密）
  - `Npgsql.EntityFrameworkCore.PostgreSQL` 10.0 - PostgreSQL 驅動
  - `FluentValidation.AspNetCore` 11.3.0 - 輸入驗證
  - `Serilog.AspNetCore` 8.0 - 結構化日誌

### Project Structure

```text
MemberService/                          # 單一資料夾包含所有專案檔案
├── MemberService.sln                   # Visual Studio 解決方案檔案
├── README.md                           # 專案說明文件
├── docker-compose.yml                  # Docker Compose 設定
├── Dockerfile                          # Docker 建置檔案
├── .gitignore                          # Git 忽略規則
├── .editorconfig                       # 編輯器設定
├── global.json                         # .NET SDK 版本鎖定
│
├── src/                                # 原始碼目錄
│   ├── MemberService.API/              # API 層：Controllers、Middlewares、Program.cs
│   ├── MemberService.Application/      # 應用層：DTOs、Services、Validators
│   ├── MemberService.Domain/           # 領域層：實體、Value Objects、介面、例外
│   └── MemberService.Infrastructure/   # 基礎設施層：EF Core、BCrypt、JWT、Snowflake ID
│
└── tests/                              # 測試專案目錄
    ├── MemberService.Domain.Tests/
    ├── MemberService.Application.Tests/
    ├── MemberService.Infrastructure.Tests/
    └── MemberService.IntegrationTests/
```

### Key Design Decisions

1. **無 AutoMapper**：使用 POCO 手動映射 DTO，提升效能與可讀性
2. **無 Minimal APIs**：採用傳統 Controller-based 設計
3. **密碼安全**：bcrypt(password + snowflakeId) 組合，提供雙重防護
4. **JWT 策略**：15 分鐘 Access Token + 7 天 Refresh Token，無狀態設計
5. **Snowflake ID**：取代 GUID，空間節省 50%，時間有序，支援分散式
6. **TDD 強制**：測試覆蓋率目標 >80%，使用 xUnit + Moq + Testcontainers

### API Endpoints

**Authentication (Public)**:
- `POST /api/auth/register` - 使用者註冊
- `POST /api/auth/login` - 使用者登入
- `POST /api/auth/refresh-token` - 更新存取權杖

**Authentication (Private)**:
- `POST /api/auth/logout` - 使用者登出（需 JWT）

**User Management (Private)**:
- `GET /api/users/me` - 查詢自己的完整資料
- `PUT /api/users/me` - 更新個人資料
- `PUT /api/users/me/password` - 變更密碼（撤銷所有 Refresh Token）
- `GET /api/users/{id}` - 查詢他人的公開資料（僅 username + createdAt）

### Database Schema

**Users Table**:
- `Id` (BIGINT, PK) - Snowflake ID
- `Email` (VARCHAR(255), UNIQUE, INDEXED) - 電子郵件
- `PasswordHash` (TEXT) - bcrypt(password + snowflakeId)
- `Username` (VARCHAR(50)) - 使用者名稱（僅字母 + 空格）
- `CreatedAt` (TIMESTAMP) - 建立時間（UTC）
- `UpdatedAt` (TIMESTAMP) - 更新時間（UTC，自動維護）

**RefreshTokens Table**:
- `Id` (UUID, PK)
- `Token` (VARCHAR(512), UNIQUE, INDEXED) - 256-bit 隨機字串
- `UserId` (BIGINT, FK → Users.Id, CASCADE DELETE)
- `ExpiresAt` (TIMESTAMP)
- `IsRevoked` (BOOLEAN, DEFAULT false)
- `CreatedAt` (TIMESTAMP)
- Composite Index: `(UserId, ExpiresAt)`

### Code Style Guidelines

**Naming Conventions**:
- 實體類別：Pascal Case（例如：`User`, `RefreshToken`）
- Value Objects：Pascal Case，不可變（例如：`Email`, `Password`, `Username`）
- 介面：`I` 前綴（例如：`IUserRepository`, `IPasswordHasher`）
- 私有欄位：`_camelCase`（例如：`_dbContext`, `_passwordHasher`）

**Architecture Rules**:
- Domain 層不依賴任何外部套件（純 C# 邏輯）
- Application 層僅依賴 Domain 介面（不依賴 Infrastructure）
- Infrastructure 實作 Domain 介面（依賴注入）
- API 層僅依賴 Application 服務（不直接呼叫 Infrastructure）

**Error Handling**:
- 使用自定義 Domain Exceptions（繼承 `DomainException`）
- API 回應格式：`{ success: bool, data?: object, error?: { code, message, timestamp, path } }`
- 所有錯誤訊息使用**繁體中文**

**Testing**:
- TDD 強制執行：先寫測試，再寫實作
- 單元測試：隔離測試，使用 Moq 模擬依賴
- 整合測試：使用 Testcontainers.PostgreSql（真實 PostgreSQL）
- 測試命名：`MethodName_StateUnderTest_ExpectedBehavior`（例如：`Register_WithDuplicateEmail_ThrowsEmailAlreadyExistsException`）

### Environment Variables

```bash
# JWT 設定
JWT_SECRET_KEY="your-super-secret-jwt-key-min-32-chars-long"  # 至少 32 字元（HS256）
JWT_ACCESS_TOKEN_EXPIRATION_MINUTES=15
JWT_REFRESH_TOKEN_EXPIRATION_DAYS=7

# 資料庫連線（本地開發）
DB_CONNECTION_STRING="Host=localhost;Port=5432;Database=memberservice_dev;Username=memberservice;Password=Dev@Password123"

# 資料庫連線（正式環境 - 範例）
# Azure: DB_CONNECTION_STRING="Host=memberservice-prod.postgres.database.azure.com;Port=5432;Database=memberservice_prod;Username=adminuser;Password=${AZURE_DB_PASSWORD};SslMode=Require"
# AWS:   DB_CONNECTION_STRING="Host=memberservice-prod.abc123.us-east-1.rds.amazonaws.com;Port=5432;Database=memberservice_prod;Username=adminuser;Password=${AWS_DB_PASSWORD};SslMode=Require"

# Snowflake ID 設定
SNOWFLAKE_WORKER_ID=1        # 0-31
SNOWFLAKE_DATACENTER_ID=1    # 0-31
```

### Database Management (Code-First)

**本地開發流程**：
```bash
# 1. 啟動本地 PostgreSQL (Docker 推薦)
docker run -d --name memberservice-db -e POSTGRES_USER=memberservice -e POSTGRES_PASSWORD=Dev@Password123 -e POSTGRES_DB=memberservice_dev -p 5432:5432 postgres:16-alpine

# 2. 建立 Migration（當修改實體類別後）
cd src/MemberService/MemberService.Infrastructure
dotnet ef migrations add YourMigrationName --startup-project ../MemberService.API

# 3. 執行 Migration（自動建立/更新資料表）
dotnet ef database update --startup-project ../MemberService.API

# 4. 回滾 Migration（如需要）
dotnet ef database update PreviousMigrationName --startup-project ../MemberService.API
```

**正式環境部署**：
- Migration 檔案隨程式碼一起版本控制（Git）
- CI/CD Pipeline 自動執行 `dotnet ef database update`
- 部署前在 Staging 環境測試 Migration
- 使用 Azure Database for PostgreSQL / AWS RDS PostgreSQL（雲端託管）
- 強制 SSL/TLS 連線、Private Endpoint、自動備份

### Performance Targets

- JWT 驗證延遲：<50ms p95
- API 端點回應時間：<200ms p95
- bcrypt 密碼雜湊：~250-350ms（work factor 12）
- Snowflake ID 產生：<1ms
- 資料庫查詢（索引命中）：<20ms

### Common Tasks

**建立資料庫遷移**:
```bash
cd src/MemberService/MemberService.Infrastructure
dotnet ef migrations add YourMigrationName --startup-project ../MemberService.API
dotnet ef database update --startup-project ../MemberService.API
```

**執行測試**:
```bash
# 所有測試
dotnet test

# 僅單元測試
dotnet test --filter "FullyQualifiedName~Tests" --exclude-filter "IntegrationTests"

# 僅整合測試（需 Docker）
dotnet test --filter "FullyQualifiedName~IntegrationTests"
```

**啟動開發伺服器**:
```bash
cd src/MemberService/MemberService.API
dotnet watch run  # http://localhost:5001
```

### Documentation References

- Specification: `specs/001-member-service/spec.md`
- Implementation Plan: `specs/001-member-service/plan.md`
- Technical Research: `specs/001-member-service/research.md`
- Data Model: `specs/001-member-service/data-model.md`
- API Contracts: `specs/001-member-service/contracts/openapi.yaml`
- Quickstart Guide: `specs/001-member-service/quickstart.md`

---

**注意事項**：
- 此檔案僅供 feature 分支使用，避免與其他 service 分支產生合併衝突
- 合併到 master 時，內容將整合到全域 `.github/copilot-instructions.md`
- 請勿手動編輯此檔案，由 `update-agent-context.sh` 自動產生
