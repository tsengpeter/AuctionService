name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  NODE_VERSION: '18.x'

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: auction_dev
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Cache .NET build artifacts
      uses: actions/cache@v4
      with:
        path: |
          ~/.nuget/packages
          ~/.dotnet/tools
          src/**/bin
          src/**/obj
          tests/**/bin
          tests/**/obj
        key: ${{ runner.os }}-dotnet-${{ hashFiles('**/*.csproj', '**/*.sln') }}
        restore-keys: |
          ${{ runner.os }}-dotnet-

    - name: Install .NET tools
      run: |
        dotnet tool install --global dotnet-ef
        dotnet tool install --global dotnet-reportgenerator-globaltool

    - name: Restore dependencies
      run: dotnet restore AuctionService.sln

    - name: Check code formatting
      run: |
        dotnet format --verify-no-changes AuctionService.sln || (
          echo "Code is not properly formatted. Run 'dotnet format' locally."
          exit 1
        )

    - name: Build solution
      run: dotnet build AuctionService.sln --configuration Release --no-restore

    - name: Run unit tests
      run: |
        dotnet test tests/AuctionService.UnitTests/AuctionService.UnitTests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results-unit.trx" \
          --results-directory ./test-results/unit

    - name: Run contract tests
      run: |
        dotnet test tests/AuctionService.ContractTests/AuctionService.ContractTests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results-contract.trx" \
          --results-directory ./test-results/contract

    - name: Setup test database
      run: |
        PGPASSWORD=postgres psql -h localhost -U postgres -d auction_dev -f scripts/init-db.sql

    - name: Run integration tests
      run: |
        dotnet test tests/AuctionService.IntegrationTests/AuctionService.IntegrationTests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results-integration.trx" \
          --results-directory ./test-results/integration
      env:
        ConnectionStrings__AuctionDb: "Host=localhost;Port=5432;Database=auction_dev;Username=postgres;Password=postgres;Include Error Detail=true"
        ASPNETCORE_ENVIRONMENT: Testing

    - name: Generate test reports
      if: always()
      run: |
        npm install -g trx-parser
        mkdir -p test-reports

        # Convert TRX files to JUnit XML
        for trx_file in test-results/**/*.trx; do
          if [ -f "$trx_file" ]; then
            trx2junit "$trx_file" > "${trx_file%.trx}.xml"
          fi
        done

        # Generate HTML test report
        echo "<html><head><title>Test Results</title></head><body>" > test-reports/index.html
        echo "<h1>Test Results Summary</h1>" >> test-reports/index.html
        echo "<table border='1'><tr><th>Test Type</th><th>Result</th><th>Details</th></tr>" >> test-reports/index.html

        for xml_file in test-results/**/*.xml; do
          if [ -f "$xml_file" ]; then
            test_type=$(basename "$(dirname "$xml_file")")
            failures=$(grep -c "<failure>" "$xml_file" || echo "0")
            total=$(grep -c "<test-case>" "$xml_file" || echo "0")
            passed=$((total - failures))

            if [ "$failures" -eq 0 ]; then
              result="<span style='color: green'>PASS</span>"
            else
              result="<span style='color: red'>FAIL</span>"
            fi

            echo "<tr><td>$test_type</td><td>$result</td><td>$passed/$total passed</td></tr>" >> test-reports/index.html
          fi
        done

        echo "</table></body></html>" >> test-reports/index.html

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          test-results/
          test-reports/
        retention-days: 30

    - name: Check test results
      if: always()
      run: |
        # Check if any tests failed
        if find test-results -name "*.trx" -exec grep -l "<ResultSummary outcome=\"Failed\">" {} \;; then
          echo "Some tests failed. Check the test results artifact for details."
          exit 1
        fi

    - name: Build Docker image
      run: |
        docker build -t auction-service:${{ github.sha }} -f Dockerfile .

    - name: Validate Docker image
      run: |
        # Quick smoke test - check if container starts
        docker run --rm -d --name auction-test auction-service:${{ github.sha }}
        sleep 10

        # Check if health endpoint responds
        if curl -f http://localhost:8080/health; then
          echo "Health check passed"
        else
          echo "Health check failed"
          docker logs auction-test
          exit 1
        fi

        docker stop auction-test

    - name: Generate build artifacts
      run: |
        mkdir -p artifacts

        # Create deployment package
        dotnet publish src/AuctionService.Api/AuctionService.Api.csproj \
          --configuration Release \
          --output artifacts/publish \
          --runtime linux-x64 \
          --self-contained false

        # Copy deployment files
        cp docker-compose.yml artifacts/
        cp Dockerfile artifacts/
        cp scripts/init-db.sql artifacts/
        cp -r docs/ artifacts/

        # Create archive
        cd artifacts
        tar -czf auction-service-${{ github.sha }}.tar.gz *

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: auction-service-build-${{ github.sha }}
        path: artifacts/
        retention-days: 7

    - name: SonarCloud Scan
      if: github.event_name == 'pull_request'
      uses: sonarsource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        projectBaseDir: .

    - name: Comment PR with build status
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { exec } = require('child_process');
          const { promisify } = require('util');
          const execAsync = promisify(exec);

          try {
            // Get test summary
            const { stdout: testSummary } = await execAsync('find test-results -name "*.trx" -exec grep -h "<ResultSummary" {} \\; | head -3');

            const comment = `## ðŸ—ï¸ Build Status

âœ… **Build completed successfully**

### Test Results
\`\`\`
${testSummary || 'No test results found'}
\`\`\`

### Artifacts
- ðŸ“¦ [Build Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
- ðŸ§ª [Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

_This build was triggered by ${{ github.event_name }} on \`${{ github.ref }}\`_`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not post PR comment:', error.message);
          }